import json
import os
from django.conf import settings
import django_rq
import zipfile
import io
from pathlib import Path
from django.contrib import messages
from django.shortcuts import render, redirect
from django.http import HttpResponse, Http404
from django.contrib import auth
from urllib.parse import unquote
from django.contrib.auth.forms import AuthenticationForm, UserCreationForm
from .forms import signupForm, BoardModelForm, configureUserForm
from .models import User, BoardModel, SnippetModel
from .tasks import create_snippet
from django.contrib.auth.decorators import login_required

@login_required
def download(request, snippetPk):
    object = SnippetModel.objects.get(pk=snippetPk)
    filename = object.videoFile.name.split('/')[-1]
    response = HttpResponse(object.videoFile, content_type='text/plain')
    response['Content-Disposition'] = 'attachment; filename=%s' % filename

    return response

@login_required
def download_board(request, boardPk):
    board = BoardModel.objects.get(pk=boardPk)
    filenames = list()

    for i in board.snippets():
        filenames.append(i.videoFile.path)

    zip_subdir = board.Name
    zip_filename = "%s.zip" % zip_subdir

    # Open BytesIO to grab in-memory ZIP contents
    s = io.BytesIO()

    # The zip compressor
    zf = zipfile.ZipFile(s, "w")

    for fpath in filenames:
        # Calculate path for file in zip
        fdir, fname = os.path.split(fpath)
        zip_path = os.path.join(zip_subdir, fname)

        # Add file, at correct path
        zf.write(fpath, zip_path, compress_type=zipfile.ZIP_DEFLATED)

    # Must close zip for all contents to be written
    zf.close()

    # Grab ZIP file from in-memory, make response with correct MIME-type
    resp = HttpResponse(
        s.getvalue(), content_type="application/x-zip-compressed")
    # ..and correct content-disposition
    resp['Content-Disposition'] = 'attachment; filename=%s' % zip_filename

    return resp

def home(request):
    return render(request=request, template_name="main/home.html")

def login(request):
    form_message = None
    if request.method == 'POST':
        form = AuthenticationForm(request=request, data=request.POST)

        if form.is_valid():
            username = form.cleaned_data.get('username')
            password = form.cleaned_data.get('password')
            print(username, password)
            user = auth.authenticate(username=username, password=password)
            if user is not None:
                auth.login(request, user)
                # messages.info(request, f"Hello, {username}")
                messages.add_message(
                    request, messages.INFO, 'Welcome back, {}!! :)'.format(user.username))

                return redirect("/dashboard")
        else:
            form_message = "Invalid username or password."
    form = AuthenticationForm()
    return render(request=request, template_name="main/login.html", context={"form_message": form_message})


@login_required
def logout(request):
    messages.add_message(request, messages.WARNING, 'You have logged out :o')
    auth.logout(request)
    return redirect("/")


def signup(request):
    error_message = None
    if request.method == 'POST':

        form = signupForm(request.POST)

        if form.is_valid():
            username = form.cleaned_data.get('username')
            raw_password = form.cleaned_data.get('password1')
            form.save()
            user = auth.authenticate(username=username, password=raw_password)
            auth.login(request, user)
            messages.add_message(
                request, messages.INFO, 'Welcome here!! :)')

            return redirect('/dashboard')

        else:
            messages.add_message(
                request, messages.WARNING, 'Username already exists. Login instead?')

            error_message = "Username already exists. Login instead?"

    return render(request=request, template_name="main/signup.html", context={'error_message': error_message})


@login_required
def dashboard(request):
    if request.method == "POST":
        query = request.POST['query'].strip('][').split(', ')
        snippets = SnippetModel.objects.filter(Tags__contains=query)
        messages.add_message(request, messages.SUCCESS,
                             'Query successful!! :)')

        return render(request=request, template_name="main/snippets.html", context={'snippets': snippets})

    board_list = request.user.boards()
    tag_autocomplete_data = request.user.allTags
    return render(request=request, template_name="main/dashboard.html", context={'board_list': board_list, 'tag_autocomplete_data': tag_autocomplete_data, 'board_count': board_list.count()})


@login_required
def board(request, boardPk):
    board = BoardModel.objects.get(pk=boardPk)

    if request.method == "POST":
        query = request.POST['query'].strip('][').split(', ')
        snippets = SnippetModel.objects.filter(
            Board=board, Tags__contains=query)
        messages.add_message(request, messages.SUCCESS,
                             'Query successful!! :)')

        return render(request=request, template_name="main/snippets.html", context={'boardPk': boardPk, 'snippets': snippets})

    return render(request=request, template_name="main/board.html", context={'board': board, 'snippets': board.snippets()})


